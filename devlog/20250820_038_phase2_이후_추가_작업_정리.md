# Phase 2 이후 추가 작업 정리

## 문서 정보
- **작성일**: 2025년 8월 20일
- **작성자**: Claude Code
- **문서 유형**: 추가 작업 정리
- **대상 기간**: Phase 2 완료 이후 ~ 현재

## 개요

Phase 2 (세트리스트 관리 기능) 구현 완료 이후, 사용자 피드백과 발견된 이슈들을 바탕으로 다양한 개선 작업을 수행했습니다. 본 문서는 이러한 추가 작업들을 시간순으로 정리하여 향후 개발 참고자료로 활용하고자 합니다.

## 작업 목록

### 1. 파일 업로드 시스템 버그 수정 🔧
**문제**: 파일 업로드가 성공하지만 "일부 파일 업로드 실패: 0/1 성공" 에러 메시지가 표시됨

**원인 분석**:
- 백엔드에서 upload-confirm 엔드포인트가 점수 확인만 하고 Score 모델 생성을 하지 않음
- PDF 처리가 동기적으로 실행되어 실패 시 전체 업로드가 실패로 처리됨
- 프론트엔드에서 업로드 완료 체크 로직이 비동기 상태 업데이트 전에 실행됨

**해결책**:
```python
# 백엔드: files/views.py
class UploadConfirmationView(APIView):
    def post(self, request):
        # Score 생성 로직 추가
        score = Score.objects.create(
            user=user,
            title=serializer.validated_data['title'],
            # ... 기타 필드
        )
        
        # PDF 처리를 비동기로 변경
        try:
            process_pdf_info.delay(score.id)
            generate_thumbnail.delay(score.id, page_number=1)
        except Exception as e:
            logger.warning(f"Background task queue failed: {e}")
```

```typescript
// 프론트엔드: hooks/useFileUpload.ts
const uploadAllFiles = useCallback(async () => {
  let successCount = 0;
  
  for (let i = 0; i < files.length; i++) {
    const file = files[i];
    if (file.status === 'pending') {
      try {
        await uploadFile(file, i);
        successCount++;
      } catch (error) {
        console.error(`File ${file.metadata.title} upload failed:`, error);
      }
    }
  }
  
  // 실제 성공 횟수로 결과 판단
  if (successCount === totalCount) {
    toast.success(`모든 파일(${successCount}개) 업로드 완료!`);
  } else {
    toast.error(`일부 파일 업로드 실패: ${successCount}/${totalCount} 성공`);
  }
}, [files, uploadFile, router]);
```

**파일**:
- `/backend/files/views.py`
- `/backend/files/utils.py`
- `/backend/files/serializers.py`
- `/frontend/hooks/useFileUpload.ts`

### 2. 세트리스트 다중 악보 추가 기능 구현 ✨
**요구사항**: 세트리스트에 악보를 추가할 때 여러 개를 한 번에 선택할 수 있도록 개선

**구현 내용**:

#### 백엔드: 다중 악보 추가 API
```python
# setlists/views.py
@action(detail=True, methods=['post'])
def add_items(self, request, pk=None):
    """Add multiple items to the setlist"""
    setlist = self.get_object()
    score_ids = request.data.get('score_ids', [])
    
    with transaction.atomic():
        created_items = []
        current_max_order = SetlistItem.objects.filter(
            setlist=setlist
        ).aggregate(max_order=models.Max('order_index'))['max_order'] or 0
        
        for i, score_id in enumerate(score_ids):
            # 중복 체크 및 생성
            if not SetlistItem.objects.filter(setlist=setlist, score=score).exists():
                item = SetlistItem.objects.create(
                    setlist=setlist,
                    score=score,
                    order_index=current_max_order + i + 1
                )
                created_items.append(item)
```

#### 프론트엔드: 다중 선택 UI
```typescript
// app/setlists/[id]/page.tsx
function AddScoreModal({ isOpen, onClose, onAddMultipleScores, isLoading }) {
  const [selectedScoreIds, setSelectedScoreIds] = useState<string[]>([]);

  const handleToggleScore = (scoreId: string) => {
    setSelectedScoreIds(prev => 
      prev.includes(scoreId) 
        ? prev.filter(id => id !== scoreId)
        : [...prev, scoreId]
    );
  };

  return (
    <div className="space-y-2 p-4">
      {scores.map((score) => (
        <div key={score.id} onClick={() => handleToggleScore(score.id)}>
          <input
            type="checkbox"
            checked={selectedScoreIds.includes(score.id)}
            onChange={() => handleToggleScore(score.id)}
          />
          {/* 악보 정보 표시 */}
        </div>
      ))}
    </div>
  );
}
```

**파일**:
- `/backend/setlists/views.py`
- `/frontend/app/setlists/[id]/page.tsx`
- `/frontend/hooks/useSetlistItems.ts`
- `/frontend/lib/api.ts`
- `/frontend/types/setlist.ts`

### 3. UI/UX 개선 작업들 🎨

#### 3.1 내비게이션 일관성 개선
**문제**: 일부 페이지에서 Layout 컴포넌트 import 방식이 달라 일관성 부족

**해결책**:
```typescript
// 잘못된 방식
import Layout from '@/components/ui/Layout';

// 올바른 방식
import { Layout } from '@/components/ui/Layout';
```

#### 3.2 버튼 크기 및 패딩 최적화
**문제**: 버튼 텍스트가 버튼 크기에 비해 너무 크고 패딩이 부족

**해결책**:
```typescript
// Button 컴포넌트 확장
const buttonSizes = {
  xs: 'px-2 py-1 text-xs',    // 새로 추가
  sm: 'px-3 py-1.5 text-sm',
  md: 'px-4 py-2 text-sm',
  lg: 'px-6 py-3 text-base',
};

// 적용 예시
<Button variant="outline" size="xs" className="text-red-600">
  제거
</Button>
```

#### 3.3 세트리스트 정보 표시 버그 수정
**문제**: 세트리스트 카드에서 "곡"만 표시되고 숫자가 빠짐

**원인**: 백엔드에서 `item_count` 필드를 사용하는데 프론트엔드에서 `items_count`로 접근

**해결책**:
```typescript
// types/setlist.ts
export interface Setlist {
  // ...
  item_count: number;  // items_count에서 수정
  total_pages?: number;
}

// app/setlists/page.tsx
<span>{setlist.item_count}곡</span>
```

#### 3.4 기타 UI 개선
- "← 목록" 버튼 텍스트 가시성 개선 (`variant="ghost"` 사용)
- 악보 목록에서 파일 크기 "NaN undefined" 표시 오류 수정
- 세트리스트 아이템에서 "Score [object Object]" 표시 오류 수정

### 4. 테스트 환경 개선 🧪

#### 4.1 테스트 비밀번호 복잡도 문제 해결
**문제**: E2E 테스트에서 사용하는 비밀번호가 Django 비밀번호 정책에 위반

**해결책**:
```typescript
// tests/e2e/helpers/test-utils.ts
export const TEST_USERS = {
  valid: {
    email: 'test@example.com',
    username: 'testuser',
    password: 'SecureTest123!@#',  // 'TestPassword123!@#'에서 변경
  },
};
```

### 5. 시스템 정보 업데이트 📅

#### 5.1 연도 정보 업데이트
**내용**: 푸터의 저작권 연도를 2024에서 2025로 업데이트

```typescript
// components/ui/Layout.tsx
<div className="text-sm text-gray-500">
  © 2025 ScoreMate. All rights reserved.
</div>
```

## 기술적 개선사항

### 1. 에러 처리 강화
- 파일 업로드 실패 시 더 명확한 에러 메시지 제공
- 백엔드 PDF 처리 실패가 전체 업로드를 중단시키지 않도록 개선
- 프론트엔드에서 실제 성공/실패 카운트 기반으로 결과 판단

### 2. API 설계 개선
- 세트리스트 다중 아이템 추가를 위한 새로운 엔드포인트 구현
- 트랜잭션 처리로 데이터 일관성 보장
- 중복 아이템 자동 스킵 로직 추가

### 3. 타입 안정성 향상
- 백엔드와 프론트엔드 간 필드명 불일치 해결
- TypeScript 인터페이스 정확성 개선
- API 응답 타입 정의 보완

### 4. 사용자 경험 개선
- 다중 선택 UI를 단순화하여 사용성 향상
- 버튼 크기 최적화로 시각적 균형감 개선
- 일관된 컴포넌트 사용으로 UI 통일성 확보

## 학습된 교훈

### 1. 풀스택 개발에서의 일관성 중요성
- 백엔드와 프론트엔드 간 데이터 구조 일치 필요
- API 필드명과 타입 정의의 정확한 매핑 중요

### 2. 사용자 피드백의 가치
- 실제 사용 중 발견되는 UX 문제들의 중요성
- 작은 UI 개선도 전체적인 사용 경험에 큰 영향

### 3. 비동기 처리의 복잡성
- 파일 업로드와 같은 다단계 프로세스에서 적절한 에러 처리 필요
- 백그라운드 작업 실패가 전체 프로세스를 중단시키지 않도록 설계

### 4. 테스트 환경의 현실성
- 테스트 데이터가 실제 운영 환경의 제약사항을 반영해야 함
- 비밀번호 정책, 유효성 검사 등 실제 조건과 일치시킬 필요

## 다음 단계 제안

### 1. 단위 테스트 보강
- 새로 추가된 다중 아이템 추가 기능에 대한 테스트 작성
- 파일 업로드 프로세스의 각 단계별 테스트 추가

### 2. 성능 최적화 검토
- 다중 아이템 추가 시 대량 데이터 처리 성능 테스트
- 파일 업로드 시 동시 업로드 제한 및 진행률 표시 개선

### 3. 접근성 개선
- 키보드 내비게이션 지원 강화
- 스크린 리더 호환성 검토

### 4. 모바일 최적화
- 세트리스트 다중 선택 UI의 터치 디바이스 최적화
- 작은 화면에서의 버튼 크기 및 간격 조정

## 결론

Phase 2 완료 이후 진행된 추가 작업들은 주로 사용자 경험 개선과 시스템 안정성 향상에 집중되었습니다. 특히 파일 업로드 시스템의 버그 수정과 세트리스트 다중 선택 기능 추가는 사용자들이 실제로 요청한 중요한 개선사항이었습니다.

이러한 iterative 개선 작업을 통해 시스템의 완성도가 크게 향상되었으며, 실제 사용 환경에서의 피드백이 얼마나 중요한지 재확인할 수 있었습니다. 향후 개발에서도 이런 사용자 중심의 개선 작업을 지속적으로 수행할 필요가 있습니다.

## 파일 변경 이력

### 백엔드 파일
- `/backend/files/views.py` - 업로드 확인 로직 개선
- `/backend/files/utils.py` - 쿼터 관리 시스템 개선
- `/backend/files/serializers.py` - 업로드 확인 시리얼라이저 확장
- `/backend/setlists/views.py` - 다중 아이템 추가 API 구현

### 프론트엔드 파일
- `/frontend/hooks/useFileUpload.ts` - 업로드 성공 판정 로직 수정
- `/frontend/hooks/useSetlistItems.ts` - 다중 아이템 추가 함수 추가
- `/frontend/app/setlists/[id]/page.tsx` - 다중 선택 UI 구현
- `/frontend/app/setlists/page.tsx` - 아이템 개수 표시 수정
- `/frontend/app/scores/page.tsx` - 버튼 크기 최적화
- `/frontend/app/scores/[id]/page.tsx` - 버튼 크기 최적화
- `/frontend/components/ui/Button.tsx` - xs 사이즈 추가
- `/frontend/components/ui/Layout.tsx` - 연도 업데이트, 내비게이션 개선
- `/frontend/types/setlist.ts` - 타입 정의 수정
- `/frontend/lib/api.ts` - 다중 아이템 추가 API 함수 추가
- `/frontend/tests/e2e/helpers/test-utils.ts` - 테스트 비밀번호 수정

---

**문서 작성 완료일**: 2025년 8월 20일  
**다음 리뷰 예정일**: Phase 3 계획 수립 시