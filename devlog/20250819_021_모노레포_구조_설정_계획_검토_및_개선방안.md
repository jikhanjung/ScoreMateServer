# 모노레포 구조 설정 계획 검토 및 개선방안

**작성일**: 2025-08-19  
**목적**: [20250819_020_모노레포_구조_설정_계획.md](./20250819_020_모노레포_구조_설정_계획.md) 검토 및 실무적 개선방안 제시  
**상태**: ✅ 개선된 실행 계획 완성

## 📋 기존 계획 분석

### ✅ **잘 정리된 부분들**
1. **체계적인 5단계 진행 계획**: 논리적 순서로 구성됨
2. **명확한 파일 분류**: 이동할 파일과 유지할 파일 구체적 명시
3. **Docker 설정 고려**: 모노레포 구조에 맞는 Docker Compose 설정

### ⚠️ **개선이 필요한 부분들**

#### 1. **누락된 파일 및 디렉토리**
```bash
# 기존 계획에서 누락된 중요 파일들

backend/로 이동해야 할 것들:
- pytest.ini                    # 테스트 설정 파일
- requirements-prod.txt          # 운영 환경 의존성
- Dockerfile.prod               # 운영용 Dockerfile  
- tests/                        # 백엔드 테스트 (backend/tests/로 이동)
- .coverage                     # 커버리지 설정

루트에 남겨둘 것들:
- htmlcov/                      # 테스트 커버리지 리포트 (생성 파일)
- logs/ (존재한다면)             # 로그 디렉토리
```

#### 2. **경로 업데이트 누락사항**
```python
# backend/scoremateserver/settings.py에서 수정 필요한 경로들

# 로그 파일 경로 (상대경로 조정)
LOGGING = {
    'handlers': {
        'file': {
            'filename': BASE_DIR.parent / 'logs' / 'scoremate.log',
        },
        'error_file': {
            'filename': BASE_DIR.parent / 'logs' / 'error.log',
        }
    }
}

# 정적 파일 경로 (필요시)
STATICFILES_DIRS = [
    BASE_DIR / 'static',  # backend/static/
]
```

#### 3. **Docker 설정의 실무적 문제점**

**기존 계획의 문제점:**
```yaml
# 기존 제안 (문제가 있는 부분)
frontend:
  build:
    context: ./frontend
    dockerfile: Dockerfile      # ❌ Next.js는 기본 Dockerfile 없음
  command: npm run dev          # ❌ 개발 서버 Docker 실행 비효율적
```

**실무적 한계:**
- Next.js는 기본적으로 Dockerfile을 제공하지 않음
- 개발 환경에서 Docker로 Next.js 실행은 핫 리로드 성능 저하
- node_modules 볼륨 마운트 복잡성

## 💡 **개선된 실행 계획**

### **Phase 1: 백엔드 디렉토리 이동 (개선판)**

#### 1-1. **디렉토리 생성 및 파일 이동**
```bash
# 1. backend 디렉토리 생성
mkdir backend

# 2. 핵심 Django 파일들 이동
mv manage.py backend/
mv scoremateserver/ backend/

# 3. Django 앱들 이동
mv core/ scores/ setlists/ files/ tasks/ scoremate_admin/ backend/

# 4. 의존성 및 설정 파일들 이동 (기존 + 누락분)
mv requirements*.txt backend/
mv pytest.ini backend/
mv .coverage backend/ 2>/dev/null || true  # 있으면 이동

# 5. Docker 파일들 이동  
mv Dockerfile.web Dockerfile.worker backend/
mv Dockerfile.prod backend/ 2>/dev/null || true  # 있으면 이동

# 6. 테스트 디렉토리 이동
mv tests/ backend/
```

#### 1-2. **경로 수정**
```python
# backend/scoremateserver/settings.py 수정사항

# 로그 디렉토리 경로 조정 (루트 logs/ 디렉토리 사용)
'file': {
    'filename': BASE_DIR.parent / 'logs' / 'scoremate.log',
},
'error_file': {
    'filename': BASE_DIR.parent / 'logs' / 'error.log',
},

# 기타 필요한 경로 조정사항들
```

### **Phase 2: 프론트엔드 설정 (실무 최적화)**

#### 2-1. **Next.js 프로젝트 생성**
```bash
# 프론트엔드 프로젝트 생성
npx create-next-app@latest frontend --typescript --tailwind --app

# API 클라이언트 라이브러리 추가
cd frontend
npm install @tanstack/react-query axios
npm install @types/node
npm install @headlessui/react @heroicons/react  # UI 컴포넌트
npm install recharts  # Dashboard 차트용
cd ..
```

#### 2-2. **환경변수 설정**
```bash
# frontend/.env.local 생성
echo "NEXT_PUBLIC_API_URL=http://localhost:8000" > frontend/.env.local
echo "NEXT_PUBLIC_ENV=development" >> frontend/.env.local
```

### **Phase 3: Docker 설정 업데이트 (실무 중심)**

#### 3-1. **개선된 docker-compose.yml**
```yaml
version: '3.8'

services:
  # 데이터베이스 (기존 유지)
  db:
    image: postgres:15
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-scoremate}
      POSTGRES_USER: ${POSTGRES_USER:-scoremate}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-pass}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"

  # Redis (기존 유지)
  redis:
    image: redis:7-alpine
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    ports:
      - "6379:6379"

  # MinIO 스토리지 (기존 유지)
  storage:
    image: minio/minio
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
    volumes:
      - minio_data:/data
    ports:
      - "9000:9000"
      - "9001:9001"

  # Django 백엔드 (경로 업데이트)
  web:
    build:
      context: ./backend      # 변경: ./backend
      dockerfile: Dockerfile.web
    volumes:
      - ./backend:/app        # 변경: ./backend
      - media_files:/app/media
    ports:
      - "8000:8000"
    environment:
      - DEBUG=True
      - DATABASE_URL=postgres://scoremate:pass@db:5432/scoremate
      - REDIS_URL=redis://redis:6379/0
      - STORAGE_ENDPOINT=storage:9000
    depends_on:
      - db
      - redis
      - storage
    command: python manage.py runserver 0.0.0.0:8000

  # Celery Worker (경로 업데이트)
  worker:
    build:
      context: ./backend      # 변경: ./backend
      dockerfile: Dockerfile.worker
    volumes:
      - ./backend:/app        # 변경: ./backend
      - media_files:/app/media
    environment:
      - DEBUG=True
      - DATABASE_URL=postgres://scoremate:pass@db:5432/scoremate
      - REDIS_URL=redis://redis:6379/0
      - STORAGE_ENDPOINT=storage:9000
    depends_on:
      - db
      - redis
      - storage
    command: celery -A scoremateserver worker -l info

  # Next.js 프론트엔드 (실무 최적화)
  frontend:
    image: node:18-alpine
    working_dir: /app
    volumes:
      - ./frontend:/app
      - frontend_node_modules:/app/node_modules
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=development
      - NEXT_PUBLIC_API_URL=http://localhost:8000
    command: sh -c "npm ci && npm run dev -- --hostname 0.0.0.0"
    depends_on:
      - web

  # Nginx 리버스 프록시 (선택사항)
  nginx:
    image: nginx:alpine
    volumes:
      - ./nginx:/etc/nginx/conf.d
    ports:
      - "80:80"
    depends_on:
      - web
      - frontend

volumes:
  postgres_data:
  redis_data:
  minio_data:
  media_files:
  frontend_node_modules:    # 새로 추가: node_modules 볼륨 분리
```

#### 3-2. **Nginx 설정 업데이트 (선택사항)**
```nginx
# nginx/default.conf
server {
    listen 80;
    server_name localhost;

    # API 요청은 Django 백엔드로
    location /api/ {
        proxy_pass http://web:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Admin 페이지도 Django로
    location /admin/ {
        proxy_pass http://web:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # 나머지 요청은 Next.js 프론트엔드로
    location / {
        proxy_pass http://frontend:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocket 지원 (Next.js hot reload)
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
```

### **Phase 4: 개발 편의성 개선**

#### 4-1. **루트 package.json 추가**
```json
{
  "name": "scoremate-monorepo",
  "version": "1.0.0",
  "description": "ScoreMate Server - Monorepo with Django Backend & Next.js Frontend",
  "scripts": {
    "dev": "docker-compose up",
    "dev:detached": "docker-compose up -d",
    "dev:backend": "docker-compose up web worker db redis storage",
    "dev:frontend": "cd frontend && npm run dev",
    "dev:frontend:local": "cd frontend && npm ci && npm run dev",
    
    "build": "npm run build:frontend",
    "build:frontend": "cd frontend && npm run build",
    "build:backend": "docker-compose build web worker",
    
    "test": "npm run test:backend && npm run test:frontend",
    "test:backend": "docker-compose exec web python -m pytest",
    "test:frontend": "cd frontend && npm test",
    "test:backend:coverage": "docker-compose exec web python -m pytest --cov",
    
    "lint": "npm run lint:frontend",
    "lint:frontend": "cd frontend && npm run lint",
    "lint:backend": "docker-compose exec web ruff check .",
    
    "clean": "npm run clean:frontend && docker-compose down -v",
    "clean:frontend": "cd frontend && rm -rf .next node_modules",
    
    "logs": "docker-compose logs -f",
    "logs:backend": "docker-compose logs -f web worker",
    "logs:frontend": "docker-compose logs -f frontend"
  },
  "devDependencies": {
    "concurrently": "^8.2.0"
  }
}
```

#### 4-2. **.gitignore 업데이트 (개선판)**
```gitignore
# Django
__pycache__/
*.py[cod]
*$py.class
*.so
.Python
env/
venv/
ENV/
backend/.env
backend/media/
backend/staticfiles/

# Next.js
frontend/.next/
frontend/out/
frontend/node_modules/
frontend/.env*.local

# IDE
.vscode/
.idea/
*.swp
*.swo

# OS
.DS_Store
Thumbs.db

# Docker
.dockerignore

# Logs
logs/
*.log

# Coverage
htmlcov/
.coverage
.coverage.*

# Database
*.sqlite3
*.db

# Environment variables
.env
.env.local
.env.*.local
```

### **Phase 5: 개발 워크플로우 최적화**

#### 5-1. **개발 환경 별 실행 방법**
```bash
# 전체 스택 Docker로 실행 (권장)
npm run dev

# 백엔드만 Docker, 프론트엔드는 로컬에서 실행 (개발 시 빠른 리로드)
npm run dev:backend
npm run dev:frontend:local  # 별도 터미널에서

# 개별 서비스 로그 확인
npm run logs:backend
npm run logs:frontend
```

#### 5-2. **테스트 실행**
```bash
# 전체 테스트
npm test

# 백엔드 테스트만
npm run test:backend

# 프론트엔드 테스트만  
npm run test:frontend

# 커버리지 포함 백엔드 테스트
npm run test:backend:coverage
```

## 🔄 **마이그레이션 체크리스트**

### **사전 준비**
- [ ] 현재 작업 커밋 및 백업
- [ ] Docker 컨테이너 정지: `docker-compose down`
- [ ] 기존 이미지 정리: `docker-compose down --rmi all`

### **Step 1: 백엔드 이동**
- [ ] backend/ 디렉토리 생성
- [ ] Django 파일들 이동 (manage.py, scoremateserver/, apps/, etc.)
- [ ] 설정 파일들 이동 (requirements*.txt, pytest.ini, etc.)
- [ ] Docker 파일들 이동 (Dockerfile.web, Dockerfile.worker, etc.)
- [ ] 테스트 디렉토리 이동 (tests/ → backend/tests/)
- [ ] settings.py 경로 수정 확인

### **Step 2: 프론트엔드 설정**
- [ ] Next.js 프로젝트 생성
- [ ] 필수 라이브러리 설치
- [ ] 환경변수 파일 생성
- [ ] API 클라이언트 기본 구조 생성

### **Step 3: Docker 설정**
- [ ] docker-compose.yml 업데이트
- [ ] nginx 설정 업데이트 (필요시)
- [ ] 볼륨 설정 확인
- [ ] 환경변수 설정 확인

### **Step 4: 개발 도구**
- [ ] 루트 package.json 생성
- [ ] .gitignore 업데이트
- [ ] 개발 스크립트 테스트

### **Step 5: 검증**
- [ ] 백엔드 Docker 빌드 및 실행 테스트
- [ ] 프론트엔드 Docker 빌드 및 실행 테스트
- [ ] API 통신 테스트
- [ ] 기존 테스트 슈트 실행 확인

## ⚡ **성능 최적화 팁**

### **개발 환경 최적화**
```bash
# 1. node_modules 볼륨 분리로 성능 향상
volumes:
  - frontend_node_modules:/app/node_modules

# 2. Next.js turbopack 사용 (더 빠른 개발 서버)
command: sh -c "npm ci && npm run dev -- --turbo --hostname 0.0.0.0"

# 3. Docker layer 캐싱 최적화
# package.json만 먼저 복사 후 npm ci
```

### **메모리 사용량 최적화**
```yaml
# Docker Compose에서 메모리 제한
frontend:
  # ...
  deploy:
    resources:
      limits:
        memory: 1G
      reservations:
        memory: 512M
```

## 🚨 **주의사항 및 트러블슈팅**

### **일반적인 문제점들**

1. **포트 충돌**
```bash
# 해결: 기존 서비스 종료 후 재시작
docker-compose down
sudo lsof -i :3000  # 포트 사용 프로세스 확인
docker-compose up
```

2. **볼륨 마운트 권한 문제**
```bash
# 해결: 소유권 변경
sudo chown -R $USER:$USER frontend/
```

3. **node_modules 동기화 문제**
```bash
# 해결: 볼륨 재생성
docker-compose down -v
docker-compose up --build
```

### **개발 워크플로우 권장사항**

1. **백엔드 개발 시**: Docker 환경 사용 (DB, Redis 의존성)
2. **프론트엔드 개발 시**: 로컬 환경 사용 (빠른 리로드)
3. **통합 테스트 시**: 전체 Docker 환경 사용

## 🎊 **결론 및 다음 단계**

### **개선된 계획의 장점**
- ✅ **완전한 파일 목록**: 누락된 파일들 포함
- ✅ **실무 최적화**: Docker 설정의 현실적 문제 해결
- ✅ **개발 편의성**: 통합 스크립트 및 워크플로우 제공
- ✅ **확장성**: 향후 배포 및 CI/CD 구축 용이

### **권장 실행 순서**
1. **백엔드 이동 및 테스트** (기존 기능 보존 확인)
2. **프론트엔드 기본 구조 구축** (API 연동 테스트)
3. **Docker 통합 환경 구축** (전체 스택 테스트)
4. **개발 도구 및 스크립트 구성** (생산성 향상)

이 개선된 계획을 따르면 **실무에서 바로 사용 가능한 모노레포 환경**을 구축할 수 있습니다!

---

**다음 문서**: 모노레포 마이그레이션 실행 및 검증 보고서  
**참고 문서**: [모노레포 구조 설정 계획](./20250819_020_모노레포_구조_설정_계획.md)