### **2단계: JWT 인증 및 API 구현 - 상세 개발 계획**

**목표:**
핵심 인증 엔드포인트와 악보, 파일, 세트리스트에 대한 초기 API 엔드포인트를 구현하고, JWT 기반 인증이 정상적으로 작동하도록 합니다.

**전제 조건 (이미 충족됨):**
*   1단계 개발 완료 (모델, 기본 Django 설정, Docker 환경).
*   `djangorestframework` 및 `djangorestframework-simplejwt` 설치 및 `settings.py` 설정 완료.
*   Python 3.12, Django 5.0 환경.

---

**상세 개발 단계:**

**1. 인증(Auth) API 구현 (`core` 앱):**

*   **`POST /auth/register` (사용자 등록)**:
    *   DRF 시리얼라이저(`UserRegistrationSerializer`)를 생성하여 사용자 등록 필드(이메일, 비밀번호 등)를 정의합니다.
    *   DRF 뷰(`UserRegistrationView`, 예: `generics.CreateAPIView`)를 구현하여 사용자 생성 로직을 처리합니다.
    *   1단계에서 구현된 `User` 모델의 기본 쿼터 할당 로직이 사용자 등록 시 자동으로 적용되도록 합니다.
    *   `scoremateserver/urls.py` 및 `core/urls.py`에 URL 패턴을 추가합니다.
*   **`POST /auth/login` (로그인 및 JWT 토큰 발급)**:
    *   `djangorestframework_simplejwt.views.TokenObtainPairView`를 사용하여 JWT 액세스/리프레시 토큰 발급 기능을 구현합니다.
    *   관련 URL 패턴을 추가합니다.
*   **`POST /auth/logout` (선택 사항, MVP에서는 연기 가능)**:
    *   리프레시 토큰 블랙리스트 처리가 필요한 경우 `djangorestframework_simplejwt.views.TokenBlacklistView`를 활용하여 구현합니다.

**2. 악보(Scores) API 구현 (`scores` 앱):**

*   **시리얼라이저**:
    *   `Score` 모델을 위한 `ScoreSerializer`를 생성합니다 (읽기/쓰기).
    *   `tags` 필드(PostgreSQL `ArrayField`)가 시리얼라이저에서 올바르게 처리되도록 합니다.
*   **뷰**:
    *   **`GET /scores` (목록/검색)**:
        *   `ScoreListView` (예: `generics.ListAPIView` 또는 `ModelViewSet`)를 구현합니다.
        *   `query` 및 `tag` 파라미터를 이용한 필터링/검색 기능을 추가합니다.
        *   페이지네이션을 구현합니다.
        *   요청 사용자의 악보만 반환되도록 권한을 설정합니다.
    *   **`POST /scores` (메타데이터 생성)**:
        *   `ScoreCreateView` (예: `ModelViewSet`의 일부)를 구현합니다.
        *   이 엔드포인트는 파일이 S3에 업로드된 **후** 악보 메타데이터를 생성하는 역할을 합니다.
        *   `title`, `composer`, `instrumentation`, `content_hash` 등의 필드를 받습니다.
        *   메타데이터 생성 후 백그라운드 작업(`PDF_INFO`, `THUMBNAIL`)을 트리거합니다.
    *   **`GET /scores/{id}` (메타데이터 조회)**:
        *   `ScoreDetailView` (예: `ModelViewSet`의 일부)를 구현합니다.
        *   `title`, `composer`, `pages`, `thumbnail_key` (프리사인드 URL 생성에 사용될 키) 등을 반환합니다.
        *   요청 사용자의 악보만 조회 가능하도록 권한을 설정합니다.
    *   **`PATCH /scores/{id}` (메타데이터/태그/노트 업데이트)**:
        *   `ScoreUpdateView` (예: `ModelViewSet`의 일부)를 구현합니다.
        *   요청 사용자의 악보만 업데이트 가능하도록 권한을 설정합니다.
    *   **`DELETE /scores/{id}` (삭제)**:
        *   `ScoreDestroyView` (예: `ModelViewSet`의 일부)를 구현합니다.
        *   요청 사용자의 악보만 삭제 가능하도록 권한을 설정합니다.
        *   S3에서 실제 파일을 삭제하는 백그라운드 작업을 트리거합니다.
*   **URL**: `scoremateserver/urls.py` 및 `scores/urls.py`에 URL 패턴을 추가합니다.

**3. 파일(Files) API 구현 (`files` 앱):**

*   **`POST /files/upload-url` (프리사인드 PUT URL 발급)**:
    *   `FileUploadURLView`를 구현합니다.
    *   클라이언트로부터 파일 `size` 및 `MIME` 타입을 받습니다.
    *   사용자의 쿼터(`User.can_upload()`) 및 `ALLOWED_MIME`을 검증합니다.
    *   `boto3`를 사용하여 S3/MinIO에 업로드할 수 있는 프리사인드 PUT URL을 생성합니다.
    *   `url`, `headers`, `content_hash_token` (필요 시)을 반환합니다.
*   **`GET /files/download-url?score_id=&page=` (프리사인드 GET URL 발급)**:
    *   `FileDownloadURLView`를 구현합니다.
    *   `score_id` 및 선택적 `page` 파라미터를 받습니다.
    *   사용자가 해당 악보의 소유자인지 검증합니다.
    *   S3/MinIO에서 단기 유효 기간의 프리사인드 GET URL을 생성하여 반환합니다.
*   **URL**: `scoremateserver/urls.py` 및 `files/urls.py`에 URL 패턴을 추가합니다.

**4. 세트리스트(Setlists) API 구현 (`setlists` 앱):**

*   **시리얼라이저**:
    *   `Setlist` 모델을 위한 `SetlistSerializer`를 생성합니다.
    *   `SetlistItem` 모델을 위한 `SetlistItemSerializer`를 생성합니다.
*   **뷰**:
    *   **`GET /setlists`**: 사용자의 세트리스트 목록을 반환합니다.
    *   **`POST /setlists`**: 새로운 세트리스트를 생성합니다.
    *   **`PATCH /setlists/{id}`**: 세트리스트 메타데이터를 업데이트합니다.
    *   **`POST /setlists/{id}/items`**: 세트리스트에 아이템을 추가/순서를 업데이트합니다.
    *   **`DELETE /setlists/{id}`**: 세트리스트를 삭제합니다.
*   **URL**: `scoremateserver/urls.py` 및 `setlists/urls.py`에 URL 패턴을 추가합니다.

**5. 백그라운드 작업(Celery Task) 통합 (`tasks` 앱):**

*   **Celery 앱 설정**: `scoremateserver/celery.py` 및 `tasks/__init__.py`에 Celery 앱 인스턴스를 설정합니다.
*   **태스크 정의**:
    *   `pdf_info_task`: `score_id`를 받아 S3에서 PDF를 읽고, 페이지 수/메타데이터를 추출하여 `Score` 모델을 업데이트합니다.
    *   `thumbnail_task`: `score_id`를 받아 커버 썸네일을 생성하고 S3에 업로드한 후 `Score` 모델을 업데이트합니다.
    *   `delete_file_task`: `s3_key`를 받아 S3에서 파일을 삭제합니다.
*   **태스크 트리거링**: 해당 API 뷰에서 적절한 시점에 이 태스크들을 트리거하도록 구현합니다 (예: `POST /scores`에서 `pdf_info_task`, `thumbnail_task` 트리거; `DELETE /scores/{id}`에서 `delete_file_task` 트리거).

**6. URL 설정 (`scoremateserver/urls.py`):**

*   `core.urls`, `scores.urls`, `files.urls`, `setlists.urls`를 포함하도록 설정합니다.
*   기존 `admin/` URL을 유지합니다.

---

**테스트 (2단계):**

*   **API 엔드포인트 테스트**: `pytest-django`와 `APIClient`를 사용하여 구현된 모든 API 엔드포인트를 테스트합니다.
    *   인증 (JWT 토큰 유효성, 유효하지 않은 토큰).
    *   인가 (사용자는 자신의 데이터에만 접근할 수 있는지).
    *   요청/응답 유효성 검사 (시리얼라이저).
    *   올바른 데이터베이스 상호작용.
    *   백그라운드 태스크 트리거링.
*   **Celery 태스크 테스트**: Celery 태스크를 독립적으로 테스트합니다 (S3 상호작용은 목킹).

**최종 산출물:**

*   인증, 악보, 파일, 세트리스트에 대한 API 엔드포인트 구현 완료.
*   PDF 처리 및 파일 관리를 위한 백그라운드 태스크 기능 구현 완료.
*   구현된 모든 API 엔드포인트 및 태스크에 대한 자동화된 테스트 코드.
