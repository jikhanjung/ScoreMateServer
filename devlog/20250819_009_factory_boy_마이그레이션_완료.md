# Factory_boy 마이그레이션 완료 보고서

**날짜**: 2025-08-19  
**작업자**: Claude Code  
**단계**: Testing Infrastructure Modernization  

## 작업 개요

기존 `TestDataMixin` 방식의 테스트 데이터 생성을 `factory_boy` 라이브러리로 마이그레이션하여 더 현대적이고 유연한 테스트 인프라를 구축했습니다.

## 마이그레이션 동기

### 기존 방식의 한계
- **정적 데이터**: 항상 동일한 테스트 데이터 생성
- **반복적 코드**: 각 테스트에서 비슷한 객체 생성 로직 반복
- **관계 관리 복잡성**: 연관 객체 생성 시 수동 처리 필요
- **확장성 부족**: 새로운 테스트 시나리오 추가 시 코드 중복

### Factory_boy의 장점
- **동적 데이터 생성**: Faker 통합으로 다양한 랜덤 데이터
- **관계 자동 관리**: SubFactory로 연관 객체 자동 생성
- **배치 생성**: `create_batch()` 메서드로 대량 데이터 생성
- **빌드 vs 생성**: `build()` (메모리) vs `create()` (DB) 선택 가능

## 구현된 Factory 클래스

### 1. UserFactory
```python
class UserFactory(factory.django.DjangoModelFactory):
    class Meta:
        model = User
        skip_postgeneration_save = True
    
    username = factory.Sequence(lambda n: f"user{n}")
    email = factory.Sequence(lambda n: f"user{n}@example.com")
    plan = "solo"
    total_quota_mb = 200
    used_quota_mb = 0
    
    @factory.post_generation
    def password(obj, create, extracted, **kwargs):
        if create:
            obj.set_password(extracted or 'testpass123')
            obj.save()
```

**특징:**
- 고유한 username/email 자동 생성 (`factory.Sequence`)
- 비밀번호 해싱 자동 처리 (`@factory.post_generation`)
- Factory_boy 경고 방지 (`skip_postgeneration_save = True`)

### 2. ScoreFactory
```python
class ScoreFactory(factory.django.DjangoModelFactory):
    class Meta:
        model = Score
    
    user = factory.SubFactory(UserFactory)
    title = factory.Faker('sentence', nb_words=3)
    composer = factory.Faker('name')
    instrumentation = factory.Iterator(['Piano', 'Full Orchestra', 'String Quartet', 'Solo Violin'])
    s3_key = factory.LazyAttribute(lambda obj: f"{obj.user.id}/scores/test/original.pdf")
    size_bytes = factory.Faker('pyint', min_value=1024*1024, max_value=50*1024*1024)
    mime = "application/pdf"
    pages = factory.Faker('pyint', min_value=1, max_value=100)
    tags = factory.List([factory.Faker('word') for _ in range(3)])
```

**특징:**
- **Faker 통합**: 실제적인 제목, 작곡가명 생성
- **SubFactory**: User 객체 자동 생성 및 연결
- **Iterator**: 정해진 목록에서 순환 선택
- **LazyAttribute**: 다른 속성 참조하는 동적 값 생성

### 3. SetlistFactory & SetlistItemFactory
```python
class SetlistFactory(factory.django.DjangoModelFactory):
    user = factory.SubFactory(UserFactory)
    title = factory.Faker('sentence', nb_words=4)
    description = factory.Faker('text', max_nb_chars=200)

class SetlistItemFactory(factory.django.DjangoModelFactory):
    setlist = factory.SubFactory(SetlistFactory)
    score = factory.SubFactory(ScoreFactory)
    notes = factory.Faker('text', max_nb_chars=100)
```

**특징:**
- 연관 객체 자동 생성 및 연결
- 다양한 길이의 텍스트 데이터 생성

## 마이그레이션 과정

### 1. 기존 코드 변경사항

#### Before: TestDataMixin 방식
```python
# conftest.py
class TestDataMixin:
    @staticmethod
    def create_test_user(email="test@example.com", username="testuser", plan="solo"):
        return User.objects.create_user(
            username=username,
            email=email,
            password="testpass123",
            plan=plan,
            total_quota_mb=200,
            used_quota_mb=0
        )

# 테스트에서 사용
class TestUserQuotaSystem(TestCase, TestDataMixin):
    def setUp(self):
        self.user = self.create_test_user(email="quota@test.com", username="quotauser")
```

#### After: Factory_boy 방식
```python
# tests/factories.py - 별도 파일로 분리
class UserFactory(factory.django.DjangoModelFactory):
    # ... factory 정의

# 테스트에서 사용  
from .factories import UserFactory

class TestUserQuotaSystem(TestCase):
    def setUp(self):
        self.user = UserFactory(email="quota@test.com", username="quotauser")
```

### 2. Django 설정 문제 해결

**문제**: Factory 파일 import 시 Django 설정 오류
```
django.core.exceptions.ImproperlyConfigured: Requested setting INSTALLED_APPS, but settings are not configured
```

**해결**: conftest.py에서 Django 설정 명시적 로드
```python
# tests/conftest.py
import os
import django
from django.conf import settings

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'scoremateserver.settings')
django.setup()
```

### 3. 테스트 파일별 변경사항

#### test_core_models.py
- **8개 메서드** 마이그레이션 완료
- `TestDataMixin` 상속 제거
- 모든 객체 생성을 Factory로 대체

#### test_scores_models.py  
- **9개 메서드** 마이그레이션 완료
- S3 키 생성 로직 Factory에서 처리
- 파일 크기, 페이지 수 등 Faker로 다양화

#### test_setlists_models.py
- **13개 메서드** 마이그레이션 완료
- Setlist-Score 관계 Factory에서 자동 처리
- 순서 관리 로직 그대로 유지

## 마이그레이션 결과

### 테스트 실행 결과
```bash
============================= test session starts ==============================
collected 30 items

tests/test_core_models.py ........                                       [ 26%]
tests/test_scores_models.py .........                                    [ 56%]
tests/test_setlists_models.py .............                              [100%]

================================ 30 passed in 13.62s ==============================
```

### 코드 커버리지
- **92% 전체 커버리지** (이전 97%에서 약간 감소, factories.py 추가로 인함)
- **핵심 비즈니스 로직 100% 커버리지** 유지

### 성능 개선
- **테스트 실행 시간**: 약간 증가 (더 복잡한 데이터 생성으로 인함)
- **메모리 효율성**: `build()` vs `create()` 선택 가능으로 개선 가능

## Factory_boy 활용 예시

### 1. 기본 사용법
```python
# 단일 객체 생성
user = UserFactory()
user = UserFactory(email="specific@test.com")

# 여러 객체 생성
users = UserFactory.create_batch(10)

# 메모리에만 생성 (DB 저장 안함)
user = UserFactory.build()
```

### 2. 관계 객체 생성
```python
# Score 생성 시 User 자동 생성
score = ScoreFactory()  # user도 자동 생성됨

# 기존 User와 연결
score = ScoreFactory(user=existing_user)

# SetlistItem 생성 시 Setlist, Score, User 모두 자동 생성
item = SetlistItemFactory()
```

### 3. 고급 활용
```python
# 특정 조건의 사용자들 생성
pro_users = UserFactory.create_batch(5, plan="pro", total_quota_mb=1000)

# 동일한 Setlist에 여러 아이템 추가
setlist = SetlistFactory()
items = SetlistItemFactory.create_batch(3, setlist=setlist)
```

## 기술적 이점

### 1. 코드 품질 향상
- **DRY 원칙**: 중복 코드 제거
- **가독성**: 테스트 의도 명확화
- **유지보수**: Factory 중앙 집중 관리

### 2. 테스트 다양성
- **랜덤 데이터**: Faker로 다양한 시나리오 테스트
- **엣지 케이스**: 다양한 데이터 조합으로 버그 발견 가능성 증가

### 3. 확장성
- **새 모델 추가**: Factory 패턴으로 쉬운 확장
- **복잡한 관계**: SubFactory로 간단한 처리

## 남은 과제

### 1. 성능 최적화
- 필요 시 `build()` vs `create()` 선택적 사용
- 테스트별 트랜잭션 최적화

### 2. 추가 Factory 구현
- Phase 2에서 추가될 모델들 (JWT Token 등)
- API 테스트용 특수 Factory

### 3. 테스트 데이터 관리
- 테스트간 데이터 격리 보장
- 대용량 데이터 테스트 시나리오

## 결론

`factory_boy` 마이그레이션을 통해 ScoreMateServer의 테스트 인프라가 크게 현대화되었습니다. 이제 더 유연하고 확장 가능한 테스트 환경에서 Phase 2 개발을 진행할 수 있습니다.

**다음 단계**: Phase 2 JWT 인증 및 API 엔드포인트 구현 시 새로운 Factory 클래스들을 추가하여 API 테스트까지 포함하는 완전한 테스트 스위트를 구축할 예정입니다.