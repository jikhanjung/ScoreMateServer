# 20250820_039_다운로드_기능_및_작곡자_필드_개선_완료

## 개요
이번 세션에서는 다음 두 가지 주요 문제를 해결했습니다:
1. 악보 다운로드 기능이 작동하지 않던 문제 해결 (original_filename 필드 추가)
2. PDF 메타데이터에서 이상한 값이 작곡자로 자동 설정되는 문제 해결 및 편집 기능 개선

## 문제 상황

### 1. 다운로드 기능 오류
- **500 Internal Server Error**: 악보 상세 페이지에서 다운로드 버튼 클릭 시 서버 오류 발생
- **AttributeError**: Score 모델에 `filename` 속성이 없어서 다운로드 시 파일명을 찾을 수 없었음
- **원본 파일명 부재**: 업로드된 파일의 원본 파일명과 사용자가 편집한 제목이 구분되지 않았음

### 2. 작곡자 필드 관련 문제
- **PDF 메타데이터 오용**: PDF의 Author 필드에서 소프트웨어 이름, 계정명 등 이상한 값이 작곡자로 자동 설정됨
  - 예시: `'Author': '  D'`, `'Creator': 'Adobe Acrobat'` 등
- **편집 불가**: 작곡자 정보가 없으면 상세 페이지에서 편집할 수 없었음
- **불필요한 필드**: 백엔드에 없는 `arranger` 필드가 프론트엔드에서 사용되고 있었음

## 해결 방법

### 1. 다운로드 기능 수정

#### Score 모델에 original_filename 필드 추가 (`scores/models.py`)
```python
original_filename = models.CharField(
    max_length=255, 
    blank=True,
    help_text="Original filename when uploaded"
)
```

#### 데이터베이스 마이그레이션
```bash
docker-compose exec web python manage.py makemigrations scores
docker-compose exec web python manage.py migrate
```

#### 업로드 로직 수정 (`files/views.py`, `files/utils.py`)
- `QuotaManager.reserve_quota` 메서드에 `original_filename` 파라미터 추가
- 업로드 확인 시 `original_filename` 필드에 원본 파일명 저장
- 다운로드 시 `original_filename`이 있으면 사용, 없으면 제목 사용

```python
# files/views.py - UploadConfirmationView
score = Score.objects.create(
    user=user,
    title=serializer.validated_data['title'],
    original_filename=original_filename,  # 추가됨
    # ... 기타 필드들
)

# files/views.py - FileDirectDownloadView  
if score.original_filename:
    filename = score.original_filename
else:
    filename = f"{score.title}.pdf"
```

### 2. PDF 메타데이터 처리 개선 (`tasks/pdf_tasks.py`)
```python
# Before: PDF Author를 자동으로 작곡자로 설정
if not score.composer and metadata.get('Author'):
    score.composer = metadata['Author'][:100]

# After: PDF 메타데이터에서 작곡자 자동 설정 제거
# Don't automatically set composer from PDF metadata as it's often incorrect
# PDF Author field commonly contains software names, user accounts, etc.
# Let users manually set composer information
```

**변경 사항:**
- PDF 메타데이터에서 작곡자 자동 설정 로직 완전 제거
- 제목만 PDF 메타데이터에서 가져오되, 공백 제거 로직 추가
- 작곡자 정보는 사용자가 수동으로 입력하도록 변경

### 3. 프론트엔드 수정 (`frontend/app/scores/[id]/page.tsx`)

#### 작곡자 필드 항상 표시
```tsx
// Before: 작곡자가 있을 때만 표시
{score.composer && (
  <p className="mt-1 text-lg text-gray-600">
    {/* ... */}
  </p>
)}

// After: 항상 표시하되 없으면 안내 메시지
<p className="mt-1 text-lg text-gray-600">
  {isEditing ? (
    <input
      type="text"
      value={editForm.composer}
      onChange={(e) => setEditForm({ ...editForm, composer: e.target.value })}
      placeholder="작곡가"
      className="border-b border-gray-300 focus:outline-none focus:border-blue-500"
    />
  ) : score.composer ? (
    score.composer
  ) : (
    <span className="text-gray-400 italic">작곡가 미입력</span>
  )}
</p>
```

#### 불필요한 편곡자 필드 제거
- `editForm`에서 `arranger` 필드 제거
- 편곡자 관련 입력 필드 및 표시 로직 완전 제거
- 백엔드 모델에 없는 필드이므로 프론트엔드에서도 제거

## 결과

### 다운로드 기능 정상화
1. **500 오류 해결**: 다운로드 시 서버 오류가 더 이상 발생하지 않음
2. **원본 파일명 보존**: 업로드된 원본 파일명과 사용자 편집 제목 분리
3. **다운로드 파일명 개선**: 원본 파일명이 있으면 사용, 없으면 제목 사용

### 작곡자 필드 개선
1. **깔끔한 작곡자 정보**: PDF 메타데이터의 이상한 값이 더 이상 자동으로 들어가지 않음
2. **편집 가능성**: 작곡자 정보가 없어도 언제든 편집 모드에서 추가/수정 가능
3. **명확한 상태 표시**: 작곡자가 없을 때 "작곡가 미입력" 안내 메시지 표시

### 기술적 개선
1. **데이터베이스 스키마 개선**: `original_filename` 필드 추가로 파일명과 제목 분리
2. **데이터 무결성**: PDF 메타데이터 오용 방지
3. **코드 일관성**: 백엔드 모델과 프론트엔드 필드 일치
4. **사용자 제어**: 메타데이터 자동 설정 대신 사용자 수동 입력 방식

## 관련 파일

### 백엔드
- `/backend/scores/models.py` - Score 모델 (`original_filename` 필드 추가)
- `/backend/scores/migrations/0002_score_original_filename.py` - 데이터베이스 마이그레이션
- `/backend/files/views.py` - 업로드/다운로드 로직 (`UploadConfirmationView`, `FileDirectDownloadView`)
- `/backend/files/utils.py` - `QuotaManager.reserve_quota` 메서드 수정
- `/backend/tasks/pdf_tasks.py` - PDF 메타데이터 처리 로직 개선

### 프론트엔드  
- `/frontend/app/scores/[id]/page.tsx` - 악보 상세 페이지 UI (작곡자 필드 항상 표시, 편곡자 필드 제거)

## 테스트 완료
- [x] 악보 업로드 정상 작동
- [x] 다운로드 기능 정상 작동 (500 오류 해결)
- [x] 원본 파일명과 제목 분리 저장
- [x] 작곡자 필드 편집 기능 (빈 값도 편집 가능)
- [x] PDF 메타데이터에서 이상한 작곡자 정보 자동 설정 방지

## 다음 단계
- 기존 악보들 중 이상한 작곡자 정보가 있는 경우 일괄 정리 필요시 별도 마이그레이션 스크립트 작성 가능
- 사용자들이 작곡자 정보를 쉽게 입력할 수 있는 자동완성 기능 추후 고려 가능
- 기존 업로드된 악보들의 `original_filename` 필드를 s3_key에서 추출하여 백필하는 마이그레이션 스크립트 고려