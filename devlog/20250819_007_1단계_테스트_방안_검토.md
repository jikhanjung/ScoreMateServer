# 1단계 테스트 방안 검토 및 실행 계획 (2025-08-19)

## 개요
기존 `20250819_006_1단계_테스트_계획.md`를 검토하고, 실무적 관점에서 개선된 테스트 전략을 제안합니다.

## 기존 계획 평가

### ✅ 우수한 점들
1. **포괄적 범위**: 모델, 관계, Admin 인터페이스 전체 커버
2. **적절한 도구**: pytest + pytest-django + factory_boy 표준 조합 선택
3. **체계적 구조**: 앱별 테스트 파일 분리로 유지보수성 확보
4. **구체적 명세**: 각 모델별 테스트 케이스 명확히 정의

### 🔧 개선 필요사항

#### 1. Docker 환경 고려 부족
- **문제**: 기존 계획은 로컬 개발환경 기준으로 작성
- **현실**: 프로젝트가 Docker Compose 기반으로 구성됨
- **해결**: Docker 컨테이너 내에서 테스트 실행 방안 필요

#### 2. 테스트 데이터베이스 전략 미비
- **문제**: 운영 PostgreSQL과 동일한 DB 사용 계획
- **개선**: 테스트 전용 설정 필요
- **옵션**: 
  - SQLite 메모리 DB (속도 우선)
  - 별도 PostgreSQL 컨테이너 (정확성 우선)

#### 3. 실무적 우선순위 부족
- **문제**: Admin UI 테스트에 과도한 비중
- **현실**: 핵심 비즈니스 로직 테스트가 더 중요
- **개선**: 우선순위 기반 단계적 접근

## 개선된 테스트 전략

### 🎯 우선순위 기반 접근

#### 1차 우선순위: 핵심 비즈니스 로직 (🔥 필수)
```python
# User 모델 쿼터 시스템
- User.can_upload() 메서드 정확성
- available_quota_mb, quota_usage_percentage 계산
- 쿼터 초과 시 업로드 차단 로직

# Score 모델 핵심 기능
- S3 키 생성 로직 (generate_s3_key, generate_thumbnail_s3_key)
- 파일 크기 계산 (size_mb 프로퍼티)
- 태그 시스템 (PostgreSQL ArrayField)

# Setlist 관리 로직
- SetlistItem 자동 순서 할당 (order_index)
- 통계 계산 (item_count, total_pages)

# Task 상태 관리
- 상태 전환 메서드 (mark_running, mark_succeeded, mark_failed)
- 시간 계산 (duration 프로퍼티)
```

#### 2차 우선순위: 데이터 무결성 (⚡ 중요)
```python
# 모델 간 관계 검증
- ForeignKey CASCADE 동작
- unique_together 제약조건
- 데이터 유효성 검사

# 로깅 시스템
- ReferralLog 중복 방지
- BillingLog 이벤트 기록
- AccessLog 감사 추적
```

#### 3차 우선순위: UI/UX 검증 (📱 선택사항)
```python
# Django Admin 인터페이스
- 모델 등록 확인
- list_display, search_fields 동작
- 인라인 편집 기능
```

### 🐳 Docker 기반 테스트 환경

#### 테스트 실행 방법
```bash
# 1. 테스트 전용 설정으로 실행
docker-compose exec web python -m pytest tests/ -v

# 2. 테스트 데이터베이스 자동 생성/정리
# Django TestCase가 자동으로 처리

# 3. 테스트 커버리지 확인
docker-compose exec web python -m pytest tests/ --cov=core --cov=scores --cov=setlists --cov=tasks
```

#### 테스트 설정 파일 (pytest.ini)
```ini
[tool:pytest]
DJANGO_SETTINGS_MODULE = scoremateserver.test_settings
addopts = --tb=short --strict-markers
testpaths = tests
python_files = test_*.py
python_classes = Test*
python_functions = test_*
```

### 📁 간소화된 테스트 구조

```
tests/
├── conftest.py              # 공통 픽스처
├── test_core_models.py       # User, 로깅 모델 테스트
├── test_scores_models.py     # Score 모델 테스트  
├── test_setlists_models.py   # Setlist 관련 테스트
├── test_tasks_models.py      # Task 모델 테스트
└── factories.py             # Factory Boy 팩토리들
```

## 단계적 실행 계획

### 🚀 Phase 1: 핵심 기능 검증 (30분 예상)
**목표**: 필수 비즈니스 로직 동작 확인
**범위**:
- User 쿼터 시스템 완전 테스트
- Score S3 키 생성 로직 검증
- SetlistItem 순서 관리 테스트

**성공 기준**:
```bash
# 모든 테스트 통과
pytest tests/test_core_models.py::TestUserQuota -v
pytest tests/test_scores_models.py::TestScoreS3Keys -v
pytest tests/test_setlists_models.py::TestOrderManagement -v
```

### ⚡ Phase 2: 통합 및 안정성 (1시간 예상)
**목표**: 모델 간 관계 및 데이터 무결성 확인
**범위**:
- CASCADE 동작 테스트
- 제약조건 검증
- 로깅 시스템 테스트

### 📱 Phase 3: 사용성 검증 (선택사항)
**목표**: Admin 인터페이스 기본 동작 확인
**방법**: 자동화보다는 수동 체크리스트 활용

## 즉시 실행 가능한 시작점

### 필요한 패키지 설치
```bash
# Docker 컨테이너에서 실행
docker-compose exec web pip install pytest pytest-django factory-boy pytest-cov
```

### 최소 테스트 파일 생성
1. `tests/conftest.py` - pytest 설정
2. `tests/test_core_models.py` - User 모델 핵심 테스트
3. `tests/factories.py` - 테스트 데이터 팩토리

## 권장사항

### ✅ 지금 당장 시작할 것
- **Phase 1만 집중**: 핵심 비즈니스 로직 검증
- **간단한 구조**: 복잡한 테스트 인프라보다는 핵심 기능 위주
- **빠른 피드백**: Docker에서 바로 실행 가능한 방식

### ⏰ 나중에 확장할 것  
- 전체 테스트 커버리지
- CI/CD 파이프라인 통합
- 성능 테스트 및 부하 테스트

## 결론
기존 테스트 계획은 훌륭하지만 너무 포괄적입니다. **핵심 비즈니스 로직부터 단계적으로 접근**하여 빠르게 신뢰성을 확보하고, 점진적으로 테스트 범위를 확장하는 것을 권장합니다.

**다음 액션**: Phase 1 핵심 테스트 구현부터 시작하시겠습니까?